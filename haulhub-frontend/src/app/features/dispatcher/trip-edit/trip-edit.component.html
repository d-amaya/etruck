<div class="trip-create-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <h1>Edit Trip</h1>
      </mat-card-title>
      <mat-card-subtitle>Update trip details including vehicle assignment, mileage, and financial information</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Information Alert -->
      <div class="info-alert">
        <mat-icon>info</mat-icon>
        <div class="info-content">
          <strong>Note:</strong> Scheduled pickup date/time, truck, and driver cannot be changed after trip creation. 
          To change these fields, please delete this trip and create a new one.
        </div>
      </div>

      <form [formGroup]="tripForm" (ngSubmit)="onSubmit()">
        
        <!-- Basic Trip Information -->
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Pickup Location</mat-label>
              <input matInput formControlName="pickupLocation" placeholder="Enter pickup address">
              <mat-error>{{ getErrorMessage('pickupLocation') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Dropoff Location</mat-label>
              <input matInput formControlName="dropoffLocation" placeholder="Enter dropoff address">
              <mat-error>{{ getErrorMessage('dropoffLocation') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Trip Status</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let status of statusOptions" [value]="status">
                  {{ getStatusLabel(status) }}
                </mat-option>
              </mat-select>
              <mat-hint>Update the current status of this trip</mat-hint>
              <mat-error>{{ getErrorMessage('status') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Pickup Date</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="scheduledPickupDatetime" 
                     placeholder="Select date">
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error>{{ getErrorMessage('scheduledPickupDatetime') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Pickup Time</mat-label>
              <input matInput type="time" formControlName="scheduledPickupTime" placeholder="HH:MM">
              <mat-error>{{ getErrorMessage('scheduledPickupTime') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Order Confirmation #</mat-label>
              <input matInput formControlName="orderConfirmation" placeholder="Optional">
              <mat-hint>Broker's order confirmation number</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Broker Information -->
        <div class="form-section">
          <h3>Broker</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Broker</mat-label>
              <mat-select formControlName="brokerId" [disabled]="loadingBrokers">
                <mat-option *ngFor="let broker of brokers" [value]="broker.brokerId">
                  {{ broker.brokerName }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="loadingBrokers">Loading brokers...</mat-hint>
              <mat-error>{{ getErrorMessage('brokerId') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Vehicle Assignment -->
        <div class="form-section">
          <h3>Vehicle Assignment</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Truck License Plate</mat-label>
              <input matInput formControlName="truckId" placeholder="Enter truck license plate">
              <mat-hint>Enter the license plate of the truck</mat-hint>
              <mat-error>{{ getErrorMessage('truckId') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Driver Assignment -->
        <div class="form-section">
          <h3>Driver Assignment</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Driver License</mat-label>
              <input matInput formControlName="driverId" placeholder="Driver's license number">
              <mat-hint>Enter driver's license number</mat-hint>
              <mat-error>{{ getErrorMessage('driverId') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Driver Name</mat-label>
              <input matInput formControlName="driverName" placeholder="Full name">
              <mat-hint>Enter driver's full name</mat-hint>
              <mat-error>{{ getErrorMessage('driverName') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Mileage & Fuel Management -->
        <div class="form-section">
          <h3>Mileage & Fuel Management</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Loaded Miles</mat-label>
              <input matInput type="number" step="0.1" formControlName="loadedMiles" placeholder="0.0">
              <mat-hint>Miles driven with cargo</mat-hint>
              <mat-error>{{ getErrorMessage('loadedMiles') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Empty Miles</mat-label>
              <input matInput type="number" step="0.1" formControlName="emptyMiles" placeholder="0.0">
              <mat-hint>Deadhead miles</mat-hint>
              <mat-error>{{ getErrorMessage('emptyMiles') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Total Miles</mat-label>
              <input matInput type="number" formControlName="totalMiles" readonly>
              <mat-hint>Auto-calculated</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Avg Fuel Cost ($/gallon)</mat-label>
              <input matInput type="number" step="0.01" formControlName="fuelAvgCost" placeholder="0.00">
              <mat-hint>Average fuel price (optional)</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Avg Gallons Per Mile</mat-label>
              <input matInput type="number" step="0.001" formControlName="fuelAvgGallonsPerMile" placeholder="0.000">
              <mat-hint>Fuel efficiency (optional)</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Financial Details (Enhanced) -->
        <div class="form-section">
          <h3>Financial Details</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Order Rate ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="orderRate" placeholder="0.00">
              <mat-hint>Total order amount</mat-hint>
              <mat-error>{{ getErrorMessage('orderRate') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Broker Payment ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="brokerPayment" placeholder="0.00">
              <mat-hint>Amount broker will pay</mat-hint>
              <mat-error>{{ getErrorMessage('brokerPayment') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Lorry Owner Payment ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="lorryOwnerPayment" placeholder="0.00">
              <mat-hint>Amount to pay lorry owner</mat-hint>
              <mat-error>{{ getErrorMessage('lorryOwnerPayment') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Driver Payment ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="driverPayment" placeholder="0.00">
              <mat-hint>Amount to pay driver</mat-hint>
              <mat-error>{{ getErrorMessage('driverPayment') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Driver Rate ($/mile)</mat-label>
              <input matInput type="number" step="0.01" formControlName="driverRate" placeholder="0.00">
              <mat-hint>Per-mile rate (optional)</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Lumper Fees ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="lumperFees" placeholder="0.00">
              <mat-hint>Loading/unloading fees</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>Detention Fees ($)</mat-label>
              <input matInput type="number" step="0.01" formControlName="detentionFees" placeholder="0.00">
              <mat-hint>Delay charges</mat-hint>
            </mat-form-field>
          </div>

          <!-- Calculated Profit Display -->
          <div class="profit-display">
            <span class="profit-label">{{ getProfitLabel() }}</span>
            <span class="profit-value" [ngClass]="calculateProfit() >= 0 ? 'profit-positive' : 'profit-negative'">
              {{ formatProfitAmount() }}
            </span>
          </div>
        </div>

        <!-- Enhanced Pickup Details -->
        <div class="form-section">
          <h3>Pickup Details (Optional)</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Company Name</mat-label>
              <input matInput formControlName="pickupCompany" placeholder="Pickup company">
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Phone Number</mat-label>
              <input matInput formControlName="pickupPhone" placeholder="(555) 123-4567">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address</mat-label>
              <input matInput formControlName="pickupAddress" placeholder="Street address">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>City</mat-label>
              <input matInput formControlName="pickupCity" placeholder="City">
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>State</mat-label>
              <input matInput formControlName="pickupState" placeholder="State" maxlength="2">
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>ZIP Code</mat-label>
              <input matInput formControlName="pickupZip" placeholder="12345">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Pickup Notes</mat-label>
              <textarea matInput formControlName="pickupNotes" rows="2" 
                        placeholder="Special instructions or notes"></textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- Enhanced Delivery Details -->
        <div class="form-section">
          <h3>Delivery Details (Optional)</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Company Name</mat-label>
              <input matInput formControlName="deliveryCompany" placeholder="Delivery company">
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Phone Number</mat-label>
              <input matInput formControlName="deliveryPhone" placeholder="(555) 123-4567">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Address</mat-label>
              <input matInput formControlName="deliveryAddress" placeholder="Street address">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="third-width">
              <mat-label>City</mat-label>
              <input matInput formControlName="deliveryCity" placeholder="City">
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>State</mat-label>
              <input matInput formControlName="deliveryState" placeholder="State" maxlength="2">
            </mat-form-field>

            <mat-form-field appearance="outline" class="third-width">
              <mat-label>ZIP Code</mat-label>
              <input matInput formControlName="deliveryZip" placeholder="12345">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Delivery Date</mat-label>
              <input matInput [matDatepicker]="deliveryPicker" formControlName="deliveryDate" 
                     placeholder="Select date">
              <mat-datepicker-toggle matSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
              <mat-datepicker #deliveryPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Delivery Time</mat-label>
              <input matInput type="time" formControlName="deliveryTime" placeholder="HH:MM">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Delivery Notes</mat-label>
              <textarea matInput formControlName="deliveryNotes" rows="2" 
                        placeholder="Special instructions or notes"></textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- General Notes -->
        <div class="form-section">
          <h3>Additional Notes</h3>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Trip Notes</mat-label>
              <textarea matInput formControlName="notes" rows="3" 
                        placeholder="Any additional information about this trip"></textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button mat-raised-button type="button" (click)="onCancel()" [disabled]="loading">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="submitting || loadingBrokers">
            <mat-spinner *ngIf="submitting" diameter="20" class="button-spinner"></mat-spinner>
            <span *ngIf="!submitting">Update Trip</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>

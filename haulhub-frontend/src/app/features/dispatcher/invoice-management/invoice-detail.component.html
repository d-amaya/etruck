<div class="invoice-detail-container">
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">
      <i class="icon-arrow-left"></i> Back to Invoices
    </button>
    <div class="header-actions">
      <button *ngIf="!isEditMode" class="btn btn-secondary" (click)="toggleEditMode()">
        <i class="icon-edit"></i> Edit Invoice
      </button>
      <button *ngIf="isEditMode" class="btn btn-secondary" (click)="toggleEditMode()">
        Cancel
      </button>
      <button *ngIf="isEditMode" class="btn btn-primary" (click)="saveInvoice()" [disabled]="invoiceForm.invalid || saving">
        <i class="icon-save"></i> {{ saving ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading invoice...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-secondary" (click)="goBack()">Go Back</button>
  </div>

  <!-- Invoice Content -->
  <div *ngIf="!loading && !error && trip" class="invoice-content">
    <!-- Invoice Header -->
    <div class="invoice-header">
      <div class="invoice-title">
        <h1>Invoice {{ invoiceForm.get('invoiceNumber')?.value }}</h1>
        <span class="status-badge" [ngClass]="'status-' + invoiceStatus">
          {{ invoiceStatus }}
        </span>
      </div>
      <div class="invoice-meta">
        <div class="meta-item">
          <span class="label">Trip ID:</span>
          <span class="value">{{ trip.tripId }}</span>
        </div>
        <div class="meta-item">
          <span class="label">Broker:</span>
          <span class="value">{{ trip.brokerName }}</span>
        </div>
      </div>
    </div>

    <!-- Invoice Form -->
    <form [formGroup]="invoiceForm" class="invoice-form">
      <div class="form-section">
        <h2>Invoice Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="invoiceNumber">Invoice Number *</label>
            <input 
              id="invoiceNumber"
              type="text" 
              formControlName="invoiceNumber"
              [readonly]="!isEditMode"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="invoiceDate">Invoice Date *</label>
            <input 
              id="invoiceDate"
              type="date" 
              formControlName="invoiceDate"
              [readonly]="!isEditMode"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="invoiceTerms">Payment Terms (days) *</label>
            <input 
              id="invoiceTerms"
              type="number" 
              formControlName="invoiceTerms"
              [readonly]="!isEditMode"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Due Date</label>
            <input 
              type="text" 
              [value]="formatDate(invoiceDueDate)"
              readonly
              class="form-input readonly">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Financial Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="invoiceSubtotal">Subtotal *</label>
            <input 
              id="invoiceSubtotal"
              type="number" 
              step="0.01"
              formControlName="invoiceSubtotal"
              [readonly]="!isEditMode"
              class="form-input">
          </div>

          <div class="form-group">
            <label for="invoiceTax">Tax</label>
            <input 
              id="invoiceTax"
              type="number" 
              step="0.01"
              formControlName="invoiceTax"
              [readonly]="!isEditMode"
              class="form-input">
          </div>

          <div class="form-group total-group">
            <label>Total</label>
            <div class="total-value">{{ formatCurrency(invoiceTotal) }}</div>
          </div>
        </div>
      </div>
    </form>

    <!-- Payment Summary -->
    <div class="payment-summary">
      <h2>Payment Summary</h2>
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">Invoice Total:</span>
          <span class="value">{{ formatCurrency(invoiceTotal) }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Total Paid:</span>
          <span class="value paid">{{ formatCurrency(totalPaid) }}</span>
        </div>
        <div class="summary-item highlight">
          <span class="label">Amount Due:</span>
          <span class="value">{{ formatCurrency(amountDue) }}</span>
        </div>
      </div>
    </div>

    <!-- Payment History -->
    <div class="payment-history">
      <div class="section-header">
        <h2>Payment History</h2>
        <button 
          *ngIf="amountDue > 0" 
          class="btn btn-primary" 
          (click)="togglePaymentForm()">
          <i class="icon-plus"></i> Add Payment
        </button>
      </div>

      <!-- Add Payment Form -->
      <div *ngIf="showPaymentForm" class="payment-form-container">
        <form [formGroup]="paymentForm" class="payment-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="paymentAmount">Amount *</label>
              <input 
                id="paymentAmount"
                type="number" 
                step="0.01"
                formControlName="amount"
                class="form-input">
            </div>

            <div class="form-group">
              <label for="paymentDate">Payment Date *</label>
              <input 
                id="paymentDate"
                type="date" 
                formControlName="paymentDate"
                class="form-input">
            </div>

            <div class="form-group">
              <label for="paymentMethod">Payment Method</label>
              <select id="paymentMethod" formControlName="paymentMethod" class="form-select">
                <option value="">Select method</option>
                <option value="check">Check</option>
                <option value="wire">Wire Transfer</option>
                <option value="ach">ACH</option>
                <option value="cash">Cash</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="paymentNotes">Notes</label>
              <textarea 
                id="paymentNotes"
                formControlName="notes"
                rows="2"
                class="form-textarea"></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="togglePaymentForm()">
              Cancel
            </button>
            <button 
              type="button" 
              class="btn btn-primary" 
              (click)="addPayment()"
              [disabled]="paymentForm.invalid || saving">
              {{ saving ? 'Adding...' : 'Add Payment' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Payment List -->
      <div class="payment-list">
        <div *ngIf="!trip.invoicePayments || trip.invoicePayments.length === 0" class="no-payments">
          No payments recorded yet
        </div>

        <div *ngFor="let payment of trip.invoicePayments" class="payment-item">
          <div class="payment-info">
            <div class="payment-amount">{{ formatCurrency(payment.amount) }}</div>
            <div class="payment-date">{{ formatDate(payment.paymentDate) }}</div>
            <div *ngIf="payment.paymentMethod" class="payment-method">
              via {{ payment.paymentMethod }}
            </div>
          </div>
          <div *ngIf="payment.notes" class="payment-notes">
            {{ payment.notes }}
          </div>
        </div>
      </div>
    </div>

    <!-- Trip Details Reference -->
    <div class="trip-reference">
      <h2>Trip Details</h2>
      <div class="reference-grid">
        <div class="reference-item">
          <span class="label">Pickup:</span>
          <span class="value">{{ trip.pickupLocation }}</span>
        </div>
        <div class="reference-item">
          <span class="label">Delivery:</span>
          <span class="value">{{ trip.dropoffLocation }}</span>
        </div>
        <div class="reference-item">
          <span class="label">Driver:</span>
          <span class="value">{{ trip.driverName }}</span>
        </div>
        <div class="reference-item">
          <span class="label">Truck:</span>
          <span class="value">{{ trip.lorryId }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

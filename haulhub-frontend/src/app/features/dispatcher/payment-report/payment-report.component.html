<div class="payment-report-container">
  <!-- Export Button (visible when wrapped in dashboard) -->
  <div class="export-header" *ngIf="isWrapped" style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
    <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenu" [disabled]="loading || !report">
      <mat-icon>download</mat-icon>
      Export
    </button>
    <mat-menu #exportMenu="matMenu">
      <button mat-menu-item (click)="onExportData()">
        <mat-icon>picture_as_pdf</mat-icon> Export PDF
      </button>
      <button mat-menu-item (click)="onExportCSV()">
        <mat-icon>grid_on</mat-icon> Export Excel
      </button>
    </mat-menu>
  </div>

  <!-- Filter Form (hidden by wrapper) -->
  <form [formGroup]="filterForm" (ngSubmit)="onFilterSubmit()" class="filter-form">
    <div class="filter-row">
      <mat-form-field appearance="outline">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="loading">
          Apply Filters
        </button>
        <button mat-button type="button" (click)="onClearFilters()" [disabled]="loading">
          Clear
        </button>
      </div>
    </div>
  </form>

  <!-- Loading Spinner -->
  <div *ngIf="loading && !isWrapped" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Report Content -->
  <div *ngIf="!loading && report" class="report-content">
    <!-- Summary Cards -->
    <div class="summary-cards">
          <div class="summary-card income">
            <div class="card-icon">
              <mat-icon>attach_money</mat-icon>
            </div>
            <div class="card-content">
              <span class="card-label">Order Rate</span>
              <span class="card-value">{{ formatCurrency(report.totalBrokerPayments) }}</span>
            </div>
          </div>

          <div class="summary-card expense">
            <div class="card-icon">
              <mat-icon>payments</mat-icon>
            </div>
            <div class="card-content">
              <span class="card-label">Driver Payments</span>
              <span class="card-value">{{ formatCurrency(report.totalDriverPayments) }}</span>
            </div>
          </div>

          <div class="summary-card expense">
            <div class="card-icon">
              <mat-icon>local_gas_station</mat-icon>
            </div>
            <div class="card-content">
              <span class="card-label">Fuel Cost</span>
              <span class="card-value">{{ formatCurrency(report.totalFuelCost || 0) }}</span>
            </div>
          </div>
        </div>

        <!-- Tabbed Views -->
        <mat-tab-group class="report-tabs" [selectedIndex]="activeTabIndex" (selectedTabChange)="onTabChange($event)">
          <!-- By Broker Tab -->
          <mat-tab label="By Broker">
            <div class="tab-content">
              <div class="data-table">
                <table mat-table [dataSource]="getBrokerGroupedData()" class="analytics-table">
                <ng-container matColumnDef="brokerName">
                  <th mat-header-cell *matHeaderCellDef>Broker Name</th>
                  <td mat-cell *matCellDef="let element">{{ element.brokerName }}</td>
                </ng-container>

                <ng-container matColumnDef="totalPayment">
                  <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                  <td mat-cell *matCellDef="let element">{{ formatCurrency(element.totalPayment) }}</td>
                </ng-container>

                <ng-container matColumnDef="tripCount">
                  <th mat-header-cell *matHeaderCellDef>Order Count</th>
                  <td mat-cell *matCellDef="let element">{{ element.tripCount }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="brokerColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: brokerColumns;"></tr>
              </table>
              </div>

              <div *ngIf="getBrokerGroupedData().length === 0" class="no-data">
                No broker data available for the selected period
              </div>
            </div>
          </mat-tab>

          <!-- By Driver Tab -->
          <mat-tab label="By Driver">
            <div class="tab-content">
              <div class="data-table">
                <table mat-table [dataSource]="getDriverGroupedData()" class="analytics-table">
                <ng-container matColumnDef="driverName">
                  <th mat-header-cell *matHeaderCellDef>Driver Name</th>
                  <td mat-cell *matCellDef="let element">{{ element.driverName }}</td>
                </ng-container>

                <ng-container matColumnDef="totalPayment">
                  <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                  <td mat-cell *matCellDef="let element">{{ formatCurrency(element.totalPayment) }}</td>
                </ng-container>

                <ng-container matColumnDef="tripCount">
                  <th mat-header-cell *matHeaderCellDef>Order Count</th>
                  <td mat-cell *matCellDef="let element">{{ element.tripCount }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="driverColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: driverColumns;"></tr>
              </table>
              </div>

              <div *ngIf="getDriverGroupedData().length === 0" class="no-data">
                No driver data available for the selected period
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </div>

      <!-- No Data Message -->
      <div *ngIf="!loading && !report" class="no-data">
        No payment data available. Please adjust your filters and try again.
      </div>
</div>

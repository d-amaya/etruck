<div class="trip-detail-container">
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Loading trip details...</p>
  </div>

  <div class="error-container" *ngIf="error && !loading">
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <h2>Error Loading Trip</h2>
        <p>{{ error }}</p>
        <button mat-raised-button color="primary" (click)="onBackToTrips()">
          <mat-icon>arrow_back</mat-icon>
          Back to Dashboard
        </button>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="trip-content" *ngIf="trip && !loading">
    <mat-card class="header-card">
      <mat-card-header>
        <div class="header-title-section">
          <mat-card-title>
            <h1>Trip Details</h1>
          </mat-card-title>
          <div class="status-and-timestamps">
            <mat-chip [ngClass]="getStatusClass(trip.status)">
              {{ getStatusLabel(trip.status) }}
            </mat-chip>
            <div class="timestamp-info">
              <span class="timestamp-label">Last Updated:</span>
              <span class="timestamp-value">{{ formatDate(trip.updatedAt) }}</span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button mat-button (click)="onBackToTrips()">
            <mat-icon>arrow_back</mat-icon>
            Back to Dashboard
          </button>
          <button mat-raised-button color="primary" (click)="onEditTrip()">
            <mat-icon>edit</mat-icon>
            Edit Trip
          </button>
        </div>
      </mat-card-header>
    </mat-card>

    <div class="details-grid">

      <!-- Trip Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Trip Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Trip ID:</span>
            <span class="detail-value">{{ trip.tripId }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Scheduled Pickup:</span>
            <span class="detail-value">{{ formatDate(trip.scheduledPickupDatetime) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Pickup Location:</span>
            <span class="detail-value">{{ trip.pickupLocation }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Dropoff Location:</span>
            <span class="detail-value">{{ trip.dropoffLocation }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Broker Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Broker Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Broker Name:</span>
            <span class="detail-value">{{ trip.brokerName }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Broker ID:</span>
            <span class="detail-value">{{ trip.brokerId }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Vehicle & Driver Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Vehicle & Driver</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Truck ID:</span>
            <span class="detail-value">{{ trip.lorryId }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Driver Name:</span>
            <span class="detail-value">{{ trip.driverName }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Driver ID:</span>
            <span class="detail-value">{{ trip.driverId }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Mileage Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Mileage Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Loaded Miles:</span>
            <span class="detail-value">{{ trip.loadedMiles || trip.distance || 0 | number:'1.1-1' }} mi</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Empty Miles:</span>
            <span class="detail-value">{{ trip.emptyMiles || 0 | number:'1.1-1' }} mi</span>
          </div>
          <mat-divider></mat-divider>
          <div class="detail-row">
            <span class="detail-label"><strong>Total Miles:</strong></span>
            <span class="detail-value"><strong>{{ calculateTotalMiles() | number:'1.1-1' }} mi</strong></span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Fuel Cost Information Card -->
      <mat-card class="detail-card" *ngIf="hasFuelData()">
        <mat-card-header>
          <mat-card-title>Fuel Cost Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Avg Fuel Cost:</span>
            <span class="detail-value">{{ formatCurrency(trip.fuelAvgCost || 0) }}/gal</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Fuel Efficiency:</span>
            <span class="detail-value">{{ trip.fuelAvgGallonsPerMile || 0 | number:'1.3-3' }} gal/mi</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Est. Fuel Consumption:</span>
            <span class="detail-value">{{ calculateFuelConsumption() | number:'1.1-1' }} gal</span>
          </div>
          <mat-divider></mat-divider>
          <div class="detail-row">
            <span class="detail-label"><strong>Total Fuel Cost:</strong></span>
            <span class="detail-value payment-negative"><strong>{{ formatCurrency(calculateFuelCost()) }}</strong></span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Payment Information Card -->
      <mat-card class="detail-card payment-card">
        <mat-card-header>
          <mat-card-title>Payment Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Broker Payment:</span>
            <span class="detail-value payment-positive">{{ formatCurrency(trip.brokerPayment) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Truck Owner Payment:</span>
            <span class="detail-value payment-negative">{{ formatCurrency(trip.lorryOwnerPayment) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Driver Payment:</span>
            <span class="detail-value payment-negative">{{ formatCurrency(trip.driverPayment) }}</span>
          </div>
          <div class="detail-row" *ngIf="hasFuelData()">
            <span class="detail-label">Fuel Cost:</span>
            <span class="detail-value payment-negative">{{ formatCurrency(calculateFuelCost()) }}</span>
          </div>
          <div class="detail-row" *ngIf="trip.lumperFees && trip.lumperFees > 0">
            <span class="detail-label">Lumper Fees:</span>
            <span class="detail-value payment-negative">{{ formatCurrency(trip.lumperFees) }}</span>
          </div>
          <div class="detail-row" *ngIf="trip.detentionFees && trip.detentionFees > 0">
            <span class="detail-label">Detention Fees:</span>
            <span class="detail-value payment-negative">{{ formatCurrency(trip.detentionFees) }}</span>
          </div>
          <mat-divider></mat-divider>
          <div class="detail-row profit-row">
            <span class="detail-label">{{ calculateProfit() >= 0 ? 'Profit:' : 'Loss:' }}</span>
            <span class="detail-value" [ngClass]="calculateProfit() >= 0 ? 'payment-positive' : 'payment-negative'">
              {{ formatCurrency(Math.abs(calculateProfit())) }}
            </span>
          </div>
        </mat-card-content>
      </mat-card>


    </div>
  </div>
</div>

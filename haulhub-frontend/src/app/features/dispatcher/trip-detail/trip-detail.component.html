<div class="trip-detail-container">
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Loading trip details...</p>
  </div>

  <div class="error-container" *ngIf="error && !loading">
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <h2>Error Loading Trip</h2>
        <p>{{ error }}</p>
        <button mat-raised-button color="primary" (click)="onBackToTrips()">
          <mat-icon>arrow_back</mat-icon>
          Back to Dashboard
        </button>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="trip-content" *ngIf="trip && !loading">
    <mat-card class="header-card">
      <mat-card-header>
        <div class="header-title-section">
          <mat-card-title>
            <h1>Trip Details</h1>
          </mat-card-title>
          <div class="status-and-timestamps">
            <mat-chip [ngClass]="getStatusClass(trip.orderStatus || 'Scheduled')">
              {{ getStatusLabel(trip.orderStatus || 'Scheduled') }}
            </mat-chip>
            <div class="timestamp-info">
              <span class="timestamp-label">Last Updated:</span>
              <span class="timestamp-value">{{ formatDate(getLastUpdatedTimestamp()) }}</span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button mat-button (click)="onBackToTrips()">
            <mat-icon>arrow_back</mat-icon>
            Back to Dashboard
          </button>
          <button mat-raised-button color="primary" (click)="onEditTrip()" *ngIf="canEditTrip()">
            <mat-icon>edit</mat-icon>
            Edit Trip
          </button>
        </div>
      </mat-card-header>
    </mat-card>

    <div class="details-grid">

      <!-- Trip Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Trip Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Scheduled Pickup:</span>
            <span class="detail-value">{{ formatDate(trip.scheduledTimestamp) }}</span>
          </div>
          <div class="detail-row" *ngIf="trip.pickupTimestamp">
            <span class="detail-label">Actual Pickup:</span>
            <span class="detail-value">{{ formatDate(trip.pickupTimestamp) }}</span>
          </div>
          <div class="detail-row" *ngIf="trip.deliveryTimestamp">
            <span class="detail-label">Actual Delivery:</span>
            <span class="detail-value">{{ formatDate(trip.deliveryTimestamp) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Pickup Location:</span>
            <span class="detail-value">{{ trip.pickupCity }}, {{ trip.pickupState }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Dropoff Location:</span>
            <span class="detail-value">{{ trip.deliveryCity }}, {{ trip.deliveryState }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Broker Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Broker Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Broker ID:</span>
            <span class="detail-value">{{ trip.brokerId }}</span>
          </div>
          <div class="detail-row" *ngIf="trip.orderConfirmation">
            <span class="detail-label">Order Confirmation:</span>
            <span class="detail-value">{{ trip.orderConfirmation }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Driver Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>person</mat-icon>
            Driver Information
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Name:</span>
            <span class="detail-value">{{ getDriverName() }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">License:</span>
            <span class="detail-value">{{ getDriverLicense() }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ getDriverEmail() }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Truck & Trailer Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>local_shipping</mat-icon>
            Truck & Trailer
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="subsection">
            <h4>Truck</h4>
            <div class="detail-row">
              <span class="detail-label">Plate:</span>
              <span class="detail-value">{{ getTruckPlate() }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Brand & Year:</span>
              <span class="detail-value">{{ getTruckBrandYear() }}</span>
            </div>
          </div>
          <mat-divider></mat-divider>
          <div class="subsection">
            <h4>Trailer</h4>
            <div class="detail-row">
              <span class="detail-label">Plate:</span>
              <span class="detail-value">{{ getTrailerPlate() }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Brand & Year:</span>
              <span class="detail-value">{{ getTrailerBrandYear() }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Mileage Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Mileage Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Loaded Miles:</span>
            <span class="detail-value">{{ trip.mileageOrder || 0 | number:'1.1-1' }} mi</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Empty Miles:</span>
            <span class="detail-value">{{ trip.mileageEmpty || 0 | number:'1.1-1' }} mi</span>
          </div>
          <mat-divider></mat-divider>
          <div class="detail-row">
            <span class="detail-label"><strong>Total Miles:</strong></span>
            <span class="detail-value"><strong>{{ calculateTotalMiles() | number:'1.1-1' }} mi</strong></span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Fuel Cost Information Card -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>Fuel Cost Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-row">
            <span class="detail-label">Avg Fuel Cost:</span>
            <span class="detail-value">{{ formatCurrency(trip.fuelGasAvgCost || 0) }}/gal</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Fuel Efficiency:</span>
            <span class="detail-value">{{ trip.fuelGasAvgGallxMil || 0 | number:'1.3-3' }} gal/mi</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Est. Fuel Consumption:</span>
            <span class="detail-value">{{ calculateFuelConsumption() | number:'1.1-1' }} gal</span>
          </div>
          <mat-divider></mat-divider>
          <div class="detail-row">
            <span class="detail-label"><strong>Total Fuel Cost:</strong></span>
            <span class="detail-value payment-negative"><strong>{{ formatCurrency(calculateFuelCost()) }}</strong></span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Payment Information Card -->
      <mat-card class="detail-card payment-card">
        <mat-card-header>
          <mat-card-title>Payment Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Column 1: Revenue -->
          <div class="payment-column">
            <h4 class="section-title">Revenue</h4>
            <div class="detail-row">
              <span class="detail-label">Broker Payment:</span>
              <span class="detail-value payment-positive">{{ formatCurrency(trip.brokerPayment) }}</span>
            </div>
            <div class="detail-row indent" *ngIf="trip.brokerAdvance && trip.brokerAdvance > 0">
              <span class="detail-label">Advance Received:</span>
              <span class="detail-value payment-info">{{ formatCurrency(trip.brokerAdvance) }}</span>
            </div>
            <div class="detail-row indent" *ngIf="trip.brokerAdvance && trip.brokerAdvance > 0">
              <span class="detail-label">Balance Due:</span>
              <span class="detail-value payment-info">{{ formatCurrency(trip.brokerPayment - trip.brokerAdvance) }}</span>
            </div>
          </div>
          
          <!-- Column 2: Expenses -->
          <div class="payment-column">
            <h4 class="section-title">Expenses</h4>
            <div class="detail-row">
              <span class="detail-label">Truck Owner:</span>
              <span class="detail-value payment-negative">{{ formatCurrency(trip.truckOwnerPayment) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Driver Payment:</span>
              <span class="detail-value payment-negative">{{ formatCurrency(trip.driverPayment) }}</span>
            </div>
            <div class="detail-row indent" *ngIf="trip.driverAdvance && trip.driverAdvance > 0">
              <span class="detail-label">Advance Paid:</span>
              <span class="detail-value payment-info">{{ formatCurrency(trip.driverAdvance) }}</span>
            </div>
            <div class="detail-row indent" *ngIf="trip.driverAdvance && trip.driverAdvance > 0">
              <span class="detail-label">Balance Due:</span>
              <span class="detail-value payment-info">{{ formatCurrency(trip.driverPayment - trip.driverAdvance) }}</span>
            </div>
            <div class="detail-row" *ngIf="calculateFuelCost() > 0">
              <span class="detail-label">Fuel Cost:</span>
              <span class="detail-value payment-negative">{{ formatCurrency(calculateFuelCost()) }}</span>
            </div>
            <div class="detail-row" *ngIf="trip.lumperValue && trip.lumperValue > 0">
              <span class="detail-label">Lumper Fees:</span>
              <span class="detail-value payment-negative">{{ formatCurrency(trip.lumperValue) }}</span>
            </div>
            <div class="detail-row" *ngIf="trip.detentionValue && trip.detentionValue > 0">
              <span class="detail-label">Detention Fees:</span>
              <span class="detail-value payment-negative">{{ formatCurrency(trip.detentionValue) }}</span>
            </div>
          </div>
          
          <!-- Column 3: Summary -->
          <div class="payment-column">
            <h4 class="section-title">Summary</h4>
            
            <div class="detail-row total-row">
              <span class="detail-label"><strong>Total Expenses:</strong></span>
              <span class="detail-value payment-negative"><strong>{{ formatCurrency(calculateTotalExpenses()) }}</strong></span>
            </div>
            
            <div class="detail-row profit-row" style="margin-top: 12px;">
              <span class="detail-label"><strong>{{ calculateProfit() >= 0 ? 'Net Profit:' : 'Net Loss:' }}</strong></span>
              <span class="detail-value" [ngClass]="calculateProfit() >= 0 ? 'payment-positive' : 'payment-negative'">
                <strong>{{ formatCurrency(getAbsoluteProfit()) }}</strong>
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </div>
</div>

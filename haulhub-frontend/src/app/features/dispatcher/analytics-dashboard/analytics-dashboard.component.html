<div class="analytics-dashboard">
  <!-- Header with Date Filter -->
  <div class="page-header">
    <h1 class="page-title">Analytics</h1>
    <div class="header-actions">
      <mat-form-field appearance="outline" class="date-filter">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" 
               [max]="endDate || maxDate" (dateChange)="onDateRangeChange()">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="date-filter">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" 
               [min]="startDate" [max]="maxDate" (dateChange)="onDateRangeChange()">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>
      
      <button mat-raised-button color="primary" (click)="onRefresh()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-raised-button [matMenuTriggerFor]="exportMenu">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="onExportData()">
          <mat-icon>picture_as_pdf</mat-icon> Export PDF
        </button>
        <button mat-menu-item (click)="onExportCSV()">
          <mat-icon>grid_on</mat-icon> Export Excel
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Export Button (visible when wrapped in dashboard) -->
  <div class="export-header" *ngIf="isWrapped" style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
    <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenuWrapped">
      <mat-icon>download</mat-icon>
      Export
    </button>
    <mat-menu #exportMenuWrapped="matMenu">
      <button mat-menu-item (click)="onExportData()">
        <mat-icon>picture_as_pdf</mat-icon> Export PDF
      </button>
      <button mat-menu-item (click)="onExportCSV()">
        <mat-icon>grid_on</mat-icon> Export Excel
      </button>
    </mat-menu>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && !isWrapped" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading analytics data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="onRefresh()">
      Try Again
    </button>
  </div>

  <!-- Summary Cards (Always Visible) -->
  <div class="info-banner" *ngIf="!isLoading && !error">
    <mat-icon>info</mat-icon>
    <span>Canceled orders are excluded from all analytics calculations.</span>
  </div>

  <div *ngIf="!error" class="summary-cards">
    <div *ngFor="let kpi of kpiCards" class="summary-card" [class]="'card-' + kpi.color">
      <div class="card-icon">
        <mat-icon>{{ kpi.icon }}</mat-icon>
      </div>
      <div class="card-content">
        <span class="card-label">{{ kpi.title }}</span>
        <span class="card-value">{{ kpi.value }}</span>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <mat-tab-group *ngIf="!isLoading && !error" class="charts-section" (selectedIndexChange)="onTabChange($event)" [selectedIndex]="selectedTabIndex">
      <!-- Admin Performance Tab -->
      <mat-tab label="Admin Performance">
        <div class="tab-content">
          <mat-card class="chart-card">
            <mat-card-content>
              <div *ngIf="adminPerformanceData && adminPerformanceData.length > 0" class="data-table">
                <table class="analytics-table">
                  <thead>
                    <tr>
                      <th>Admin Name</th>
                      <th>Total Orders</th>
                      <th>Completed</th>
                      <th>Total Revenue</th>
                      <th>Total Profit</th>
                      <th>Avg Profit/Order</th>
                      <th>Completion Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let admin of adminPerformanceData">
                      <td>{{ admin.name }}</td>
                      <td>{{ admin.totalTrips }}</td>
                      <td>{{ admin.completedTrips }}</td>
                      <td>{{ formatCurrency(admin.totalRevenue) }}</td>
                      <td [class.profit-positive]="admin.totalProfit >= 0" [class.profit-negative]="admin.totalProfit < 0">
                        {{ formatCurrency(admin.totalProfit) }}
                      </td>
                      <td>{{ formatCurrency(admin.averageProfit) }}</td>
                      <td>
                        <span class="completion-badge" [class.high]="admin.completionRate >= 90"
                              [class.medium]="admin.completionRate >= 70 && admin.completionRate < 90"
                              [class.low]="admin.completionRate < 70">
                          {{ admin.completionRate | number:'1.0-0' }}%
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="no-data" *ngIf="!adminPerformanceData || adminPerformanceData.length === 0">
                <mat-icon>admin_panel_settings</mat-icon>
                <p>No admin performance data available</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Broker Performance Tab -->
      <mat-tab label="Broker Performance">
        <div class="tab-content">
          <mat-card class="chart-card">
            <mat-card-content>
              <div *ngIf="brokerAnalyticsData && brokerAnalyticsData.brokers && brokerAnalyticsData.brokers.length > 0" class="data-table">
                <table class="analytics-table">
                  <thead>
                    <tr>
                      <th>Broker Name</th>
                      <th>Total Orders</th>
                      <th>Completed</th>
                      <th>Total Revenue</th>
                      <th>Total Profit</th>
                      <th>Avg Revenue/Order</th>
                      <th>Completion Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let broker of brokerAnalyticsData.brokers">
                      <td>{{ broker.brokerName }}</td>
                      <td>{{ broker.totalTrips }}</td>
                      <td>{{ broker.completedTrips }}</td>
                      <td>{{ formatCurrency(broker.totalRevenue) }}</td>
                      <td [class.profit-positive]="broker.totalProfit >= 0" [class.profit-negative]="broker.totalProfit < 0">
                        {{ formatCurrency(broker.totalProfit) }}
                      </td>
                      <td>{{ formatCurrency(broker.averageRevenue) }}</td>
                      <td>
                        <span class="completion-badge" [class.high]="broker.completionRate >= 90"
                              [class.medium]="broker.completionRate >= 70 && broker.completionRate < 90"
                              [class.low]="broker.completionRate < 70">
                          {{ broker.completionRate | number:'1.0-0' }}%
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="no-data" *ngIf="!brokerAnalyticsData || !brokerAnalyticsData.brokers || brokerAnalyticsData.brokers.length === 0">
                <mat-icon>business</mat-icon>
                <p>No broker performance data available</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Carrier Performance Tab -->
      <mat-tab label="Carrier Performance">
        <div class="tab-content">
          <mat-card class="chart-card">
            <mat-card-content>
              <div *ngIf="carrierPerformanceData && carrierPerformanceData.length > 0" class="data-table">
                <table class="analytics-table">
                  <thead>
                    <tr>
                      <th>Carrier Name</th>
                      <th>Total Orders</th>
                      <th>Completed</th>
                      <th>Total Revenue</th>
                      <th>Total Profit</th>
                      <th>Avg Profit/Order</th>
                      <th>Completion Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let carrier of carrierPerformanceData">
                      <td>{{ carrier.name }}</td>
                      <td>{{ carrier.totalTrips }}</td>
                      <td>{{ carrier.completedTrips }}</td>
                      <td>{{ formatCurrency(carrier.totalRevenue) }}</td>
                      <td [class.profit-positive]="carrier.totalProfit >= 0" [class.profit-negative]="carrier.totalProfit < 0">
                        {{ formatCurrency(carrier.totalProfit) }}
                      </td>
                      <td>{{ formatCurrency(carrier.averageProfit) }}</td>
                      <td>
                        <span class="completion-badge" [class.high]="carrier.completionRate >= 90"
                              [class.medium]="carrier.completionRate >= 70 && carrier.completionRate < 90"
                              [class.low]="carrier.completionRate < 70">
                          {{ carrier.completionRate | number:'1.0-0' }}%
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="no-data" *ngIf="!carrierPerformanceData || carrierPerformanceData.length === 0">
                <mat-icon>local_shipping</mat-icon>
                <p>No carrier performance data available</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
</div>

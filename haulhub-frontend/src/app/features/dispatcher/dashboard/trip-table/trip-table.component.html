<div class="trip-table-container" role="region" aria-label="Order list">
  <!-- Dashboard Charts Widget -->
  <app-dashboard-charts-widget></app-dashboard-charts-widget>

  <!-- Table Filters -->
  <div class="table-filters" *ngIf="!loading">
    <form [formGroup]="filterForm" class="filter-row">
      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status" (selectionChange)="onDropdownChange()">
          <mat-option [value]="null">All Statuses</mat-option>
          <mat-option *ngFor="let status of statusOptions" [value]="status">
            {{ getStatusLabel(status) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Broker</mat-label>
        <mat-select formControlName="brokerId" (selectionChange)="onDropdownChange()">
          <mat-option [value]="null">All Brokers</mat-option>
          <mat-option *ngFor="let broker of brokers" [value]="broker.brokerId">
            {{ broker.brokerName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Truck</mat-label>
        <input type="text" matInput formControlName="truckId" [matAutocomplete]="truckAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('truckId')?.value" matSuffix mat-icon-button (click)="clearTruckFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #truckAuto="matAutocomplete" [displayWith]="displayTruck" (optionSelected)="onDropdownChange()">
          <mat-option [value]="null">All Trucks</mat-option>
          <mat-option *ngFor="let truck of filteredTrucks | async" [value]="truck.truckId">
            {{ truck.plate }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Driver</mat-label>
        <input type="text" matInput formControlName="driverId" [matAutocomplete]="driverAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('driverId')?.value" matSuffix mat-icon-button (click)="clearDriverFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #driverAuto="matAutocomplete" [displayWith]="displayDriver" (optionSelected)="onDropdownChange()">
          <mat-option [value]="null">All Drivers</mat-option>
          <mat-option *ngFor="let driver of filteredDrivers | async" [value]="driver.userId">
            {{ driver.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Carrier</mat-label>
        <input type="text" matInput formControlName="carrierId" [matAutocomplete]="carrierAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('carrierId')?.value" matSuffix mat-icon-button (click)="clearCarrierFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #carrierAuto="matAutocomplete" [displayWith]="displayCarrier" (optionSelected)="onDropdownChange()">
          <mat-option [value]="null">All Carriers</mat-option>
          <mat-option *ngFor="let owner of filteredTruckOwners | async" [value]="owner.userId">
            {{ owner.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <div class="spacer"></div>

      <div class="action-buttons-group">
        <button mat-icon-button (click)="clearAllFilters()" type="button"
                [matTooltip]="'Clear all filters'"
                class="action-btn clear-btn">
          <mat-icon>filter_alt_off</mat-icon>
        </button>

        <button mat-icon-button [matMenuTriggerFor]="exportMenu" type="button"
                [matTooltip]="'Export'"
                class="action-btn export-btn">
          <mat-icon>download</mat-icon>
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="exportPDF()">
            <mat-icon>picture_as_pdf</mat-icon> Export PDF
          </button>
          <button mat-menu-item (click)="exportCSV()">
            <mat-icon>grid_on</mat-icon> Export Excel
          </button>
        </mat-menu>

        <button mat-icon-button (click)="createTrip()" type="button"
                [matTooltip]="'Create new order'"
                class="action-btn create-btn">
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </form>
  </div>

  <div class="table-wrapper" *ngIf="!loading && trips.length > 0">
    <table mat-table [dataSource]="trips" class="trip-table" 
           role="table" [attr.aria-label]="'Trip list with ' + totalTrips + ' total trips'">
      <!-- Date Column -->
      <ng-container matColumnDef="scheduledTimestamp">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Date</th>
        <td mat-cell *matCellDef="let trip" role="gridcell" 
            [attr.aria-label]="'Scheduled for ' + formatDate(trip.scheduledTimestamp)">
          {{ formatDate(trip.scheduledTimestamp) }}
        </td>
      </ng-container>

      <!-- Time Column -->
      <ng-container matColumnDef="scheduledTime">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Time</th>
        <td mat-cell *matCellDef="let trip" role="gridcell" 
            [attr.aria-label]="'Scheduled at ' + formatTime(trip.scheduledTimestamp)">
          {{ formatTime(trip.scheduledTimestamp) }}
        </td>
      </ng-container>

      <!-- Pickup Column -->
      <ng-container matColumnDef="pickupLocation">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Pickup</th>
        <td mat-cell *matCellDef="let trip" class="location-cell" role="gridcell"
            [attr.aria-label]="'Pickup location: ' + (trip.pickupLocation || (trip.pickupCity + ', ' + trip.pickupState))">
          <span [matTooltip]="trip.pickupLocation || (trip.pickupCity + ', ' + trip.pickupState)" 
                [attr.aria-label]="trip.pickupLocation || (trip.pickupCity + ', ' + trip.pickupState)">
            {{ trip.pickupLocation || (trip.pickupCity + ', ' + trip.pickupState) }}
          </span>
        </td>
      </ng-container>

      <!-- Dropoff Column -->
      <ng-container matColumnDef="dropoffLocation">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Dropoff</th>
        <td mat-cell *matCellDef="let trip" class="location-cell" role="gridcell"
            [attr.aria-label]="'Dropoff location: ' + (trip.dropoffLocation || (trip.deliveryCity + ', ' + trip.deliveryState))">
          <span [matTooltip]="trip.dropoffLocation || (trip.deliveryCity + ', ' + trip.deliveryState)" 
                [attr.aria-label]="trip.dropoffLocation || (trip.deliveryCity + ', ' + trip.deliveryState)">
            {{ trip.dropoffLocation || (trip.deliveryCity + ', ' + trip.deliveryState) }}
          </span>
        </td>
      </ng-container>

      <!-- Broker Column -->
      <ng-container matColumnDef="brokerName">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Broker</th>
        <td mat-cell *matCellDef="let trip" role="gridcell"
            [attr.aria-label]="'Broker: ' + getBrokerName(trip.brokerId)">
          {{ getBrokerName(trip.brokerId) }}
        </td>
      </ng-container>

      <!-- Truck Column -->
      <ng-container matColumnDef="truckId">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Truck</th>
        <td mat-cell *matCellDef="let trip" role="gridcell"
            [attr.aria-label]="'Truck ID: ' + trip.truckId">
          {{ getTruckDisplay(trip.truckId) }}
        </td>
      </ng-container>

      <!-- Carrier Column -->
      <ng-container matColumnDef="carrierId">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Carrier</th>
        <td mat-cell *matCellDef="let trip" role="gridcell"
            [attr.aria-label]="'Carrier: ' + getCarrierName(trip.carrierId)">
          {{ getCarrierName(trip.carrierId) }}
        </td>
      </ng-container>

      <!-- Driver Column -->
      <ng-container matColumnDef="driverName">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Driver</th>
        <td mat-cell *matCellDef="let trip" role="gridcell"
            [attr.aria-label]="'Driver: ' + getDriverName(trip.driverId)">
          {{ getDriverName(trip.driverId) }}
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Status</th>
        <td mat-cell *matCellDef="let trip" role="gridcell">
          <mat-chip [class]="getStatusClass(trip.orderStatus || trip.status || 'Scheduled')"
                    [attr.aria-label]="getStatusAriaLabel(trip.orderStatus || trip.status || 'Scheduled')"
                    role="status">
            {{ getStatusLabel(trip.orderStatus || trip.status || 'Scheduled') }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Revenue Column -->
      <ng-container matColumnDef="revenue">
        <th mat-header-cell *matHeaderCellDef class="numeric" role="columnheader" scope="col">Revenue</th>
        <td mat-cell *matCellDef="let trip" class="numeric" role="gridcell"
            [attr.aria-label]="'Revenue: ' + formatCurrency(trip.orderRate)">
          {{ formatCurrency(trip.orderRate) }}
        </td>
      </ng-container>

      <!-- Expenses Column -->
      <ng-container matColumnDef="expenses">
        <th mat-header-cell *matHeaderCellDef class="numeric" role="columnheader" scope="col">Expenses</th>
        <td mat-cell *matCellDef="let trip" class="numeric" role="gridcell"
            [attr.aria-label]="'Expenses: ' + formatCurrency(calculateExpenses(trip))">
          {{ formatCurrency(calculateExpenses(trip)) }}
        </td>
      </ng-container>

      <!-- Profit/Loss Column -->
      <ng-container matColumnDef="profitLoss">
        <th mat-header-cell *matHeaderCellDef class="numeric" role="columnheader" scope="col">Profit/Loss</th>
        <td mat-cell *matCellDef="let trip" class="numeric" role="gridcell"
            [attr.aria-label]="getProfitAriaLabel(trip)">
          <span [class.positive-profit]="calculateProfit(trip) >= 0" 
                [class.negative-profit]="calculateProfit(trip) < 0">
            {{ formatCurrency(calculateProfit(trip)) }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Actions</th>
        <td mat-cell *matCellDef="let trip" role="gridcell">
          <div class="action-buttons" role="group" [attr.aria-label]="'Actions for trip to ' + trip.dropoffLocation">
            <button mat-icon-button class="action-btn view-btn" 
                    (click)="viewTrip(trip)"
                    (touchend)="viewTrip(trip); $event.preventDefault()"
                    [matTooltip]="'View order details'"
                    [attr.aria-label]="getActionAriaLabel('view', trip.tripId, trip.dropoffLocation)">
              <mat-icon aria-hidden="true">visibility</mat-icon>
            </button>
            <button mat-icon-button class="action-btn edit-btn" 
                    (click)="editTrip(trip)"
                    (touchend)="editTrip(trip); $event.preventDefault()"
                    [matTooltip]="'Edit order'"
                    [attr.aria-label]="getActionAriaLabel('edit', trip.tripId, trip.dropoffLocation)">
              <mat-icon aria-hidden="true">edit</mat-icon>
            </button>
            <button mat-icon-button class="action-btn delete-btn" 
                    (click)="deleteTrip(trip)"
                    (touchend)="deleteTrip(trip); $event.preventDefault()"
                    [matTooltip]="'Delete order'"
                    [attr.aria-label]="getActionAriaLabel('delete', trip.tripId, trip.dropoffLocation)">
              <mat-icon aria-hidden="true">delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns" role="row"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; let even = even; let i = index" 
          [class.even-row]="even" 
          class="trip-row"
          role="row"
          [attr.aria-rowindex]="i + 2"
          [attr.aria-label]="'Order from ' + row.pickupLocation + ' to ' + row.dropoffLocation + ' on ' + formatDate(row.scheduledTimestamp)"></tr>
    </table>

    <!-- Pagination -->
    <mat-paginator
      [length]="totalTrips"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons
      [attr.aria-label]="'Trip list pagination. Page ' + (pageIndex + 1) + ' of ' + Math.ceil(totalTrips / pageSize)">
    </mat-paginator>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && trips.length === 0" 
       role="status" aria-live="polite">
    <mat-icon aria-hidden="true">inbox</mat-icon>
    <h3>No orders found</h3>
    <p>{{ getEmptyStateMessage() }}</p>
    <button mat-raised-button color="primary" (click)="createTrip()" *ngIf="!hasActiveFilters"
            [attr.aria-label]="'Create your first trip to get started'">
      <mat-icon aria-hidden="true">add</mat-icon>
      Create Your First Trip
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]">
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
    </div>
  </div>
</div>

<mat-card>
  <mat-card-header>
    <mat-card-title>
      <h2>My Orders</h2>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <!-- Filter Form -->
    <form [formGroup]="filterForm" class="filter-form">
      <mat-form-field appearance="outline">
        <mat-label>Truck</mat-label>
        <mat-select formControlName="vehicleId">
          <mat-option value="">All Trucks</mat-option>
          <mat-option *ngFor="let truck of approvedTrucks" [value]="truck.truckId">
            {{ truck.plate }} - {{ truck.brand }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Broker</mat-label>
        <mat-select formControlName="brokerId">
          <mat-option value="">All Brokers</mat-option>
          <mat-option *ngFor="let broker of brokers" [value]="broker.brokerId">
            {{ broker.brokerName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">All Statuses</mat-option>
          <mat-option *ngFor="let status of statusOptions" [value]="status">
            {{ getStatusLabel(status) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="onApplyFilters()">
          <mat-icon>filter_list</mat-icon>
          Apply Filters
        </button>
        <button mat-button (click)="onClearFilters()" *ngIf="hasActiveFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </form>

    <!-- Loading Spinner -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner></mat-spinner>
    </div>

    <!-- No Approved Vehicles Message -->
    <div *ngIf="!loading && !hasApprovedVehicles()" class="empty-state">
      <mat-icon>local_shipping</mat-icon>
      <p>No approved trucks found</p>
      <p class="subtitle">Register and verify your trucks to see trips</p>
    </div>

    <!-- No Trips Message -->
    <div *ngIf="!loading && hasApprovedVehicles() && trips.length === 0" class="empty-state">
      <mat-icon>assignment</mat-icon>
      <p>No orders found</p>
      <p class="subtitle" *ngIf="hasActiveFilters()">Try adjusting your filters</p>
    </div>

    <!-- Trips Table -->
    <table mat-table [dataSource]="trips" *ngIf="!loading && trips.length > 0" class="trips-table">
      <!-- Scheduled Timestamp Column -->
      <ng-container matColumnDef="scheduledTimestamp">
        <th mat-header-cell *matHeaderCellDef>Scheduled</th>
        <td mat-cell *matCellDef="let trip">{{ formatDate(trip.scheduledTimestamp) }}</td>
      </ng-container>

      <!-- Pickup City Column -->
      <ng-container matColumnDef="pickupCity">
        <th mat-header-cell *matHeaderCellDef>Pickup</th>
        <td mat-cell *matCellDef="let trip">{{ trip.pickupCity }}, {{ trip.pickupState }}</td>
      </ng-container>

      <!-- Delivery City Column -->
      <ng-container matColumnDef="deliveryCity">
        <th mat-header-cell *matHeaderCellDef>Delivery</th>
        <td mat-cell *matCellDef="let trip">{{ trip.deliveryCity }}, {{ trip.deliveryState }}</td>
      </ng-container>

      <!-- Truck ID Column -->
      <ng-container matColumnDef="truckId">
        <th mat-header-cell *matHeaderCellDef>Truck</th>
        <td mat-cell *matCellDef="let trip">{{ getVehicleDisplay(trip) }}</td>
      </ng-container>

      <!-- Dispatcher ID Column -->
      <ng-container matColumnDef="dispatcherId">
        <th mat-header-cell *matHeaderCellDef>Dispatcher</th>
        <td mat-cell *matCellDef="let trip">{{ trip.dispatcherId }}</td>
      </ng-container>

      <!-- Broker Name Column -->
      <ng-container matColumnDef="brokerName">
        <th mat-header-cell *matHeaderCellDef>Broker</th>
        <td mat-cell *matCellDef="let trip">{{ getBrokerName(trip.brokerId) }}</td>
      </ng-container>

      <!-- Order Status Column -->
      <ng-container matColumnDef="orderStatus">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let trip">
          <mat-chip [ngClass]="getStatusClass(trip.orderStatus)">
            {{ getStatusLabel(trip.orderStatus) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Truck Owner Payment Column (ONLY financial field visible to truck owners) -->
      <ng-container matColumnDef="truckOwnerPayment">
        <th mat-header-cell *matHeaderCellDef>My Payment</th>
        <td mat-cell *matCellDef="let trip">{{ formatCurrency(trip.truckOwnerPayment) }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="trip-row"></tr>
    </table>

    <!-- Paginator -->
    <mat-paginator
      *ngIf="!loading && trips.length > 0"
      [length]="totalTrips"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card-content>
</mat-card>

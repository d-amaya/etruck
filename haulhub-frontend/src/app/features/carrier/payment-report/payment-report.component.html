<mat-card class="payment-report-card">
  <mat-card-header>
    <mat-card-title>Payment Report</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading payment report...</p>
    </div>

    <div *ngIf="!loading && report" class="report-content">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card revenue">
          <div class="card-icon">
            <span class="material-icons">attach_money</span>
          </div>
          <div class="card-content">
            <div class="card-label">Total Revenue</div>
            <div class="card-value">{{ report.totalBrokerPayments | currency }}</div>
          </div>
        </div>

        <div class="summary-card expenses">
          <div class="card-icon">
            <span class="material-icons">payments</span>
          </div>
          <div class="card-content">
            <div class="card-label">Total Expenses</div>
            <div class="card-value">
              {{ (report.totalDriverPayments + report.totalTruckOwnerPayments) | currency }}
            </div>
          </div>
        </div>

        <div class="summary-card profit">
          <div class="card-icon">
            <span class="material-icons">trending_up</span>
          </div>
          <div class="card-content">
            <div class="card-label">Net Profit</div>
            <div class="card-value">{{ report.profit | currency }}</div>
          </div>
        </div>

        <div class="summary-card trips">
          <div class="card-icon">
            <span class="material-icons">local_shipping</span>
          </div>
          <div class="card-content">
            <div class="card-label">Total Trips</div>
            <div class="card-value">{{ report.tripCount }}</div>
          </div>
        </div>
      </div>

      <!-- Grouped Data Tabs -->
      <mat-tab-group [(selectedIndex)]="activeTabIndex" (selectedIndexChange)="onTabChange($event)">
        <mat-tab label="By Broker">
          <div class="tab-content">
            <table mat-table [dataSource]="getEnrichedBrokerData()" class="payment-table">
              <ng-container matColumnDef="brokerName">
                <th mat-header-cell *matHeaderCellDef>Broker</th>
                <td mat-cell *matCellDef="let row">{{ row.brokerName }}</td>
              </ng-container>

              <ng-container matColumnDef="totalPayment">
                <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                <td mat-cell *matCellDef="let row">{{ row.totalPayment | currency }}</td>
              </ng-container>

              <ng-container matColumnDef="tripCount">
                <th mat-header-cell *matHeaderCellDef>Trips</th>
                <td mat-cell *matCellDef="let row">{{ row.tripCount }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="brokerColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: brokerColumns;"></tr>
            </table>
          </div>
        </mat-tab>

        <mat-tab label="By Driver">
          <div class="tab-content">
            <table mat-table [dataSource]="enrichedDriverData" class="payment-table">
              <ng-container matColumnDef="driverName">
                <th mat-header-cell *matHeaderCellDef>Driver</th>
                <td mat-cell *matCellDef="let row">{{ row.driverName }}</td>
              </ng-container>

              <ng-container matColumnDef="totalPayment">
                <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                <td mat-cell *matCellDef="let row">{{ row.totalPayment | currency }}</td>
              </ng-container>

              <ng-container matColumnDef="tripCount">
                <th mat-header-cell *matHeaderCellDef>Trips</th>
                <td mat-cell *matCellDef="let row">{{ row.tripCount }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="driverColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: driverColumns;"></tr>
            </table>
          </div>
        </mat-tab>

        <mat-tab label="By Truck">
          <div class="tab-content">
            <table mat-table [dataSource]="enrichedTruckData" class="payment-table">
              <ng-container matColumnDef="truckName">
                <th mat-header-cell *matHeaderCellDef>Truck</th>
                <td mat-cell *matCellDef="let row">{{ row.truckName }}</td>
              </ng-container>

              <ng-container matColumnDef="totalPayment">
                <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                <td mat-cell *matCellDef="let row">{{ row.totalPayment | currency }}</td>
              </ng-container>

              <ng-container matColumnDef="tripCount">
                <th mat-header-cell *matHeaderCellDef>Trips</th>
                <td mat-cell *matCellDef="let row">{{ row.tripCount }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="truckColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: truckColumns;"></tr>
            </table>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </mat-card-content>
</mat-card>

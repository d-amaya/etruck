<div class="payment-report-container">
  <!-- Export Button -->
  <div class="page-header">
    <div class="header-actions">
      <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenu" [disabled]="loading || !report">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="onExportData()">
          <mat-icon>picture_as_pdf</mat-icon> Export PDF
        </button>
        <button mat-menu-item (click)="onExportCSV()">
          <mat-icon>grid_on</mat-icon> Export Excel
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Report Content -->
  <div *ngIf="!loading && report" class="report-content">
    <!-- Summary Cards -->
    <div class="info-banner">
      <mat-icon>info</mat-icon>
      <span>Canceled orders are excluded from payment calculations.</span>
    </div>

    <div class="summary-cards">
      <div class="summary-card income">
        <div class="card-icon">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">Carrier Revenue</span>
          <span class="card-value">{{ formatCurrency(report.totalCarrierPayment || 0) }}</span>
        </div>
      </div>

      <div class="summary-card expense">
        <div class="card-icon">
          <mat-icon>payments</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">Driver Payroll</span>
          <span class="card-value">{{ formatCurrency(report.totalDriverPayment || 0) }}</span>
        </div>
      </div>

      <div class="summary-card expense">
        <div class="card-icon">
          <mat-icon>local_gas_station</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">Fuel Cost</span>
          <span class="card-value">{{ formatCurrency(report.totalFuelCost || 0) }}</span>
        </div>
      </div>

      <div class="summary-card" [class.income]="report.profit >= 0" [class.expense]="report.profit < 0">
        <div class="card-icon">
          <mat-icon>{{ report.profit >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
        </div>
        <div class="card-content">
          <span class="card-label">Net Profit</span>
          <span class="card-value">{{ formatCurrency(report.profit || 0) }}</span>
        </div>
      </div>
    </div>

    <!-- Tabbed Views -->
    <mat-tab-group class="report-tabs" [selectedIndex]="activeTabIndex" (selectedIndexChange)="onTabChange($event)">
      <!-- By Driver Tab -->
      <mat-tab label="Driver Payroll">
        <div class="tab-content">
          <div class="data-table">
            <table mat-table [dataSource]="enrichedDriverData" class="analytics-table">
              <ng-container matColumnDef="driverName">
                <th mat-header-cell *matHeaderCellDef>Driver Name</th>
                <td mat-cell *matCellDef="let element">{{ element.driverName }}</td>
              </ng-container>

              <ng-container matColumnDef="totalPayment">
                <th mat-header-cell *matHeaderCellDef>Total Payment</th>
                <td mat-cell *matCellDef="let element">{{ formatCurrency(element.totalPayment) }}</td>
              </ng-container>

              <ng-container matColumnDef="tripCount">
                <th mat-header-cell *matHeaderCellDef>Order Count</th>
                <td mat-cell *matCellDef="let element">{{ element.tripCount }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="driverColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: driverColumns;"></tr>
            </table>
          </div>

          <div *ngIf="enrichedDriverData.length === 0" class="no-data">
            No driver data available for the selected period
          </div>
        </div>
      </mat-tab>
      <!-- Fuel Efficiency Tab -->
      <mat-tab label="Fuel Cost by Truck">
        <div class="tab-content">
          <div class="data-table" *ngIf="fuelByTruck.length > 0">
            <table mat-table [dataSource]="fuelByTruck" class="analytics-table">
              <ng-container matColumnDef="truckName">
                <th mat-header-cell *matHeaderCellDef>Truck</th>
                <td mat-cell *matCellDef="let el">{{ el.truckName }}</td>
              </ng-container>
              <ng-container matColumnDef="trips">
                <th mat-header-cell *matHeaderCellDef>Trips</th>
                <td mat-cell *matCellDef="let el">{{ el.trips }}</td>
              </ng-container>
              <ng-container matColumnDef="totalMiles">
                <th mat-header-cell *matHeaderCellDef>Total Miles</th>
                <td mat-cell *matCellDef="let el">{{ el.totalMiles | number:'1.0-0' }} mi</td>
              </ng-container>
              <ng-container matColumnDef="avgMPG">
                <th mat-header-cell *matHeaderCellDef>Avg MPG</th>
                <td mat-cell *matCellDef="let el">{{ el.avgMPG | number:'1.2-2' }}</td>
              </ng-container>
              <ng-container matColumnDef="totalCost">
                <th mat-header-cell *matHeaderCellDef>Total Fuel Cost</th>
                <td mat-cell *matCellDef="let el">{{ formatCurrency(el.totalCost) }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="fuelColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: fuelColumns;"></tr>
            </table>
          </div>
          <div *ngIf="fuelByTruck.length === 0" class="no-data">
            No fuel data available for the selected period
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>

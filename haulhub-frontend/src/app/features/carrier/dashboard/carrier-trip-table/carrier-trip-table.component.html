<div class="trip-table-container">
  <!-- Dashboard Charts Widget -->
  <app-carrier-charts-widget [dashboardData]="lastDashboardResponse"></app-carrier-charts-widget>

  <!-- Table Filters -->
  <div class="table-filters" *ngIf="!loading">
    <form [formGroup]="filterForm" class="filter-row">
      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">All Statuses</mat-option>
          <mat-option *ngFor="let status of statusOptions" [value]="status">
            {{ getStatusLabel(status) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Broker</mat-label>
        <mat-select formControlName="brokerId" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">All Brokers</mat-option>
          <mat-option *ngFor="let broker of brokers" [value]="broker.brokerId">
            {{ broker.brokerName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Dispatcher</mat-label>
        <input type="text" matInput formControlName="dispatcherId" [matAutocomplete]="dispatcherAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('dispatcherId')?.value" matSuffix mat-icon-button (click)="clearDispatcherFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #dispatcherAuto="matAutocomplete" [displayWith]="displayDispatcher" (optionSelected)="onFilterChange()">
          <mat-option [value]="null">All Dispatchers</mat-option>
          <mat-option *ngFor="let dispatcher of filteredDispatchers | async" [value]="dispatcher.userId">
            {{ dispatcher.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Driver</mat-label>
        <input type="text" matInput formControlName="driverId" [matAutocomplete]="driverAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('driverId')?.value" matSuffix mat-icon-button (click)="clearDriverFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #driverAuto="matAutocomplete" [displayWith]="displayDriver" (optionSelected)="onFilterChange()">
          <mat-option [value]="null">All Drivers</mat-option>
          <mat-option *ngFor="let driver of filteredDrivers | async" [value]="driver.userId">
            {{ driver.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Truck</mat-label>
        <input type="text" matInput formControlName="truckId" [matAutocomplete]="truckAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('truckId')?.value" matSuffix mat-icon-button (click)="clearTruckFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #truckAuto="matAutocomplete" [displayWith]="displayTruck" (optionSelected)="onFilterChange()">
          <mat-option [value]="null">All Trucks</mat-option>
          <mat-option *ngFor="let truck of filteredTrucks | async" [value]="truck.truckId">
            {{ truck.plate }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Truck Owner</mat-label>
        <input type="text" matInput formControlName="truckOwnerId" [matAutocomplete]="truckOwnerAuto" placeholder="Type to search...">
        <button *ngIf="filterForm.get('truckOwnerId')?.value" matSuffix mat-icon-button (click)="clearTruckOwnerFilter(); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #truckOwnerAuto="matAutocomplete" [displayWith]="displayTruckOwner" (optionSelected)="onFilterChange()">
          <mat-option [value]="null">All Truck Owners</mat-option>
          <mat-option *ngFor="let owner of filteredTruckOwners | async" [value]="owner.userId">
            {{ owner.name }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <div class="spacer"></div>

      <div class="action-buttons-group">
        <button mat-icon-button [matMenuTriggerFor]="exportMenu" type="button"
                [matTooltip]="'Export'"
                class="action-btn export-btn">
          <mat-icon>download</mat-icon>
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="exportPDF()">
            <mat-icon>picture_as_pdf</mat-icon> Export PDF
          </button>
          <button mat-menu-item (click)="exportCSV()">
            <mat-icon>grid_on</mat-icon> Export Excel
          </button>
        </mat-menu>
        
        <button mat-icon-button (click)="clearAllFilters()" type="button"
                [matTooltip]="'Clear all filters'"
                class="action-btn clear-btn">
          <mat-icon>filter_alt_off</mat-icon>
        </button>
      </div>
    </form>
  </div>

  <div class="table-wrapper" *ngIf="!loading && trips.length > 0">
    <table mat-table [dataSource]="trips" class="trip-table">
      <!-- Date Column -->
      <ng-container matColumnDef="scheduledTimestamp">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let trip">
          {{ formatDate(trip.scheduledTimestamp) }}
        </td>
      </ng-container>

      <!-- Pickup Column -->
      <ng-container matColumnDef="pickupLocation">
        <th mat-header-cell *matHeaderCellDef>Pickup</th>
        <td mat-cell *matCellDef="let trip" class="location-cell">
          {{ trip.pickupCity }}, {{ trip.pickupState }}
        </td>
      </ng-container>

      <!-- Dropoff Column -->
      <ng-container matColumnDef="dropoffLocation">
        <th mat-header-cell *matHeaderCellDef>Dropoff</th>
        <td mat-cell *matCellDef="let trip" class="location-cell">
          {{ trip.deliveryCity }}, {{ trip.deliveryState }}
        </td>
      </ng-container>

      <!-- Dispatcher Column -->
      <ng-container matColumnDef="dispatcherName">
        <th mat-header-cell *matHeaderCellDef>Dispatcher</th>
        <td mat-cell *matCellDef="let trip">
          {{ getDispatcherDisplay(trip.dispatcherId) }}
        </td>
      </ng-container>

      <!-- Broker Column -->
      <ng-container matColumnDef="brokerName">
        <th mat-header-cell *matHeaderCellDef>Broker</th>
        <td mat-cell *matCellDef="let trip">
          {{ getBrokerDisplay(trip.brokerId) }}
        </td>
      </ng-container>

      <!-- Truck Column -->
      <ng-container matColumnDef="truckId">
        <th mat-header-cell *matHeaderCellDef>Truck</th>
        <td mat-cell *matCellDef="let trip">
          {{ getTruckDisplay(trip.truckId) }}
        </td>
      </ng-container>

      <!-- Driver Column -->
      <ng-container matColumnDef="driverName">
        <th mat-header-cell *matHeaderCellDef>Driver</th>
        <td mat-cell *matCellDef="let trip">
          {{ getDriverDisplay(trip.driverId) }}
        </td>
      </ng-container>

      <!-- Truck Owner Column -->
      <ng-container matColumnDef="truckOwnerName">
        <th mat-header-cell *matHeaderCellDef>Truck Owner</th>
        <td mat-cell *matCellDef="let trip">
          {{ getTruckOwnerDisplay(trip.truckOwnerId) }}
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let trip">
          <mat-chip [class]="getStatusClass(trip.orderStatus || trip.status)">
            {{ getStatusLabel(trip.orderStatus || trip.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Revenue Column -->
      <ng-container matColumnDef="revenue">
        <th mat-header-cell *matHeaderCellDef class="numeric">Revenue</th>
        <td mat-cell *matCellDef="let trip" class="numeric">
          {{ formatCurrency(trip.brokerPayment) }}
        </td>
      </ng-container>

      <!-- Expenses Column -->
      <ng-container matColumnDef="expenses">
        <th mat-header-cell *matHeaderCellDef class="numeric">Expenses</th>
        <td mat-cell *matCellDef="let trip" class="numeric">
          {{ formatCurrency(calculateExpenses(trip)) }}
        </td>
      </ng-container>

      <!-- Profit/Loss Column -->
      <ng-container matColumnDef="profitLoss">
        <th mat-header-cell *matHeaderCellDef class="numeric">Profit/Loss</th>
        <td mat-cell *matCellDef="let trip" class="numeric">
          <span [class.positive-profit]="calculateProfit(trip) >= 0" 
                [class.negative-profit]="calculateProfit(trip) < 0">
            {{ formatCurrency(calculateProfit(trip)) }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let trip">
          <div class="action-buttons">
            <button mat-icon-button class="action-btn view-btn" 
                    (click)="viewTrip(trip)"
                    [matTooltip]="'View order details'">
              <mat-icon>visibility</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="trip-row"></tr>
    </table>

    <mat-paginator
      [length]="totalTrips"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && trips.length === 0">
    <mat-icon>inbox</mat-icon>
    <h3>No orders found</h3>
    <p>{{ getEmptyStateMessage() }}</p>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]">
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
    </div>
  </div>
</div>
